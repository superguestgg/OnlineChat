<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ß–∞—Ç –∫–æ–º–Ω–∞—Ç—ã</title>
    <link rel="stylesheet" href="css/chat.css">
    <link rel="stylesheet" href="css/chatqr.css">
    
    <style>
        /* –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è —Å –∑–∞–ø—Ä–æ—Å–æ–º */
        .message.join-request {
            background: #fff8e1;
            margin: 10px auto;
            padding: 15px;
            border-left: 4px solid #ffc107;
        }

        .request-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .accept-btn {
            padding: 5px 10px;
            background: #4caf50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .decline-btn {
            padding: 5px 10px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
    </style>
    <script src="js/dh.js"></script>
</head>
<body>
<div id="chat-header">
    <h2 id="room-title">–ö–æ–º–Ω–∞—Ç–∞</h2>
    <div id="header-controls">
        <button id="leave-btn">–ü–æ–∫–∏–Ω—É—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
    </div>
</div>

<div id="chat-container">
    <div id="sidebar">
        <h3>–£—á–∞—Å—Ç–Ω–∏–∫–∏ (<span id="users-count">0</span>)</h3>
        <ul class="user-list" id="users-list"></ul>

        <div id="invite-section">
            <h4>–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–∑–µ–π</h4>
            <div id="invite-controls">
                <input type="text" id="invite-link" readonly>
            </div>
            <div id="invite-controls2">
                <button id="copy-btn">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                <button id="qr-btn">–ü–æ–∫–∞–∑–∞—Ç—å QR</button>
            </div>
            <div id="copy-success">–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!</div>

            <!-- –î–æ–±–∞–≤–ª—è–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è QR-–∫–æ–¥–∞ -->
            <div id="qr-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center;">
                <div style="background: white; padding: 20px; border-radius: 10px; text-align: center;">
                    <h3>QR-–∫–æ–¥ –¥–ª—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è</h3>
                    <canvas id="qr-canvas"></canvas>
                    <button id="qr-close" style="margin-top: 15px; padding: 5px 15px;">–ó–∞–∫—Ä—ã—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <div id="messages"></div>
</div>

<div id="input-area">
    <input type="text" id="message-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." disabled>
    <button id="send-btn" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>

    <div id="file-controls">
        <label for="file-input" id="file-btn" title="–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª">üìé</label>
        <button id="paste-btn" title="–í—Å—Ç–∞–≤–∏—Ç—å –∏–∑ –±—É—Ñ–µ—Ä–∞">üìã</button>
        <input type="file" id="file-input" style="display: none;">
        <button id="camera-photo-btn" title="–°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ">üì∑</button>
        <button id="camera-video-btn" title="–ó–∞–ø–∏—Å–∞—Ç—å –≤–∏–¥–µ–æ">üé•</button>
    </div>

    <div id="file-info" style="display: none;">
        <div id="file-info-top">
            <span id="file-name"></span>
            <span id="file-percent">0%</span>
        </div>
        <progress id="file-progress" value="0" max="100"></progress>
    </div>
</div>

<script src="js/signalr.min.js">
    // https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js
</script>
<script src="js/chat.js"></script>
<script src="js/chatfiles.js"></script>
<script>
    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ sessionStorage
    let chatData = JSON.parse(sessionStorage.getItem('chatData'));
    if (!chatData || !chatData.roomId || !chatData.username) {
        if (!chatData)
            chatData = Object()
        const urlParams = getUrlParams();
        if (!urlParams.roomId || !urlParams.name) {
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —á–∞—Ç–∞" + chatData.roomId + chatData.username + urlParams.roomId + urlParams.name);
            window.close();
        } else {
            const randomNum = getRandomNumber(1, 1000000);
            chatData.roomId = urlParams.roomId;
            chatData.username = urlParams.name + randomNum;
            chatData.roomName = urlParams.name;
        }
    }

    const connection = new signalR.HubConnectionBuilder()
        .withUrl("/privateChatHub")
        .configureLogging(signalR.LogLevel.Information)
        .withAutomaticReconnect()
        .build();

    // –≠–ª–µ–º–µ–Ω—Ç—ã UI
    const roomTitle = document.getElementById('room-title');
    const messagesContainer = document.getElementById('messages');
    const messageInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');
    const leaveBtn = document.getElementById('leave-btn');
    const usersList = document.getElementById('users-list');
    const usersCount = document.getElementById('users-count');
    const inviteLinkInput = document.getElementById('invite-link');
    const copyBtn = document.getElementById('copy-btn');
    const copySuccess = document.getElementById('copy-success');
    const fileInput = document.getElementById("file-input");
    const fileBtn = document.getElementById("file-btn");
    const cameraPhotoBtn = document.getElementById("camera-photo-btn");
    const cameraVideoBtn = document.getElementById("camera-video-btn");
    const pasteBtn = document.getElementById("paste-btn");
    const fileInfo = document.getElementById("file-info");
    const fileNameLabel = document.getElementById("file-name");
    const fileProgress = document.getElementById("file-progress");
    const filePercent = document.getElementById("file-percent");

    async function startConnection() {
        try {
            await connection.start();
            console.log("Connected to ChatHub");

            // –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ–º—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ
            const roomInfo = await connection.invoke("JoinRoom", chatData.roomId, chatData.username, chatData.roomName);
            const roomInfoResult = roomInfo.result;
            console.log(roomInfoResult);
            chatData.roomName = roomInfoResult.roomName;
            roomTitle.textContent = roomInfoResult.roomName;

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è
            inviteLinkInput.value = generateInviteLink(roomInfoResult.roomName);

            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º UI
            messageInput.disabled = false;
            sendBtn.disabled = false;
            messageInput.focus();

            // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            addMessage('System', `–í—ã –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ –∫–æ–º–Ω–∞—Ç–µ "${roomInfoResult.roomName}"`, 'system');

        } catch (err) {
            console.error(err);
            alert(`–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —á–∞—Ç—É ${err}`);
            window.close();
        }
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
    connection.on("ReceiveMessage", (user, message) => {
        addMessage(user, message, user === chatData.username ? 'outgoing' : 'incoming');
    });

    connection.on("UserJoined", (username) => {
        addMessage('System', `${username} –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è`, 'system');
    });

    connection.on("UserLeft", (username) => {
        addMessage('System', `${username} –ø–æ–∫–∏–Ω—É–ª —á–∞—Ç`, 'system');
    });

    connection.on("UpdateUsers", (users) => {
        updateUsersList(users);
    });

    // –ù–æ–≤—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
    connection.on("UserWantJoin", (userId, username) => {
        addJoinRequestMessage(userId, username);
    });

    connection.on("Declined", (reason) => {
        addMessage('System', `–í–∞—à –∑–∞–ø—Ä–æ—Å –±—ã–ª –æ—Ç–∫–ª–æ–Ω–µ–Ω: ${reason || '–±–µ–∑ —É–∫–∞–∑–∞–Ω–∏—è –ø—Ä–∏—á–∏–Ω—ã'}`, 'declined');
    });

    connection.on("UserDeclined", (adminName, declinedUserName, reason) => {
        const messageText = reason
            ? `${adminName} –æ—Ç–∫–ª–æ–Ω–∏–ª –∑–∞–ø—Ä–æ—Å –æ—Ç ${declinedUserName}. –ü—Ä–∏—á–∏–Ω–∞: ${reason}`
            : `${adminName} –æ—Ç–∫–ª–æ–Ω–∏–ª –∑–∞–ø—Ä–æ—Å –æ—Ç ${declinedUserName}`;

        addMessage('System', messageText, 'declined-notification');
    });

    // –ù–æ–≤—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø—Ä–∏–Ω—è—Ç–∏—è
    connection.on("Accepted", () => {
        addMessage('System', '–í–∞—à –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –±—ã–ª –ø—Ä–∏–Ω—è—Ç!', 'system');
    });

    connection.on("UserAccepted", (adminName, acceptedUserName) => {
        addMessage('System', `${adminName} –ø—Ä–∏–Ω—è–ª –∑–∞–ø—Ä–æ—Å –æ—Ç ${acceptedUserName}`, 'accepted-notification');
    });
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è —Å –∑–∞–ø—Ä–æ—Å–æ–º –Ω–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
    function addJoinRequestMessage(userId, username) {
        const messageElement = document.createElement('div');
        messageElement.className = 'message join-request';
        messageElement.innerHTML = `
            <strong>${username}</strong> —Ö–æ—á–µ—Ç –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ —á–∞—Ç—É.
            <div class="request-buttons">
                <button class="accept-btn" data-user-id="${userId}">–ü—Ä–∏–Ω—è—Ç—å</button>
                <button class="decline-btn" data-user-id="${userId}">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
            </div>
        `;
        messagesContainer.appendChild(messageElement);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ü—Ä–∏–Ω—è—Ç—å"
        messageElement.querySelector('.accept-btn').addEventListener('click', async () => {
            try {
                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –î–∏—Ñ—Ñ–∏-–•–µ–ª–ª–º–∞–Ω–∞
                const p = generatePrime(32);
                const g = 2n;
                const privateKey = generatePrivateKey(p);
                const publicKey = generatePublicKey(g, privateKey, p);

                await connection.invoke("AcceptUserToRoom", chatData.roomId, userId, {
                    p: p.toString(),
                    g: g.toString(),
                    publicKey: publicKey.toString()
                });

                messageElement.remove();

                // –õ–æ–∫–∞–ª—å–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
                addMessage('System', `–í—ã –ø—Ä–∏–Ω—è–ª–∏ –∑–∞–ø—Ä–æ—Å –æ—Ç ${username}`, 'system');

                sessionStorage.setItem('dhParams', JSON.stringify({
                    p: p.toString(),
                    g: g.toString(),
                    privateKey: privateKey.toString(),
                    otherPublicKey: null
                }));

            } catch (err) {
                console.error("Error accepting user:", err);
                addMessage('System', '–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏–Ω—è—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ' + err.message, 'system');
            }
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–û—Ç–∫–ª–æ–Ω–∏—Ç—å"
        messageElement.querySelector('.decline-btn').addEventListener('click', async () => {
            try {
                await connection.invoke("Decline", chatData.roomId, userId);
                messageElement.remove();
                addMessage('System', `–í—ã –æ—Ç–∫–ª–æ–Ω–∏–ª–∏ –∑–∞–ø—Ä–æ—Å –æ—Ç ${username}}`, 'system');
            } catch (err) {
                console.error("Error declining user:", err);
                addMessage('System', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å: ' + err.message, 'system');
            }
        });
    }

    let inIteration = 0;

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ (–ø–æ–ª—É—á–∞–µ–º –ø—Ä–æ—Å—Ç–æ–µ —á–∏—Å–ª–æ p –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞)
    connection.on("StartCreatingToken", (primeNumber) => {
        try {
            inIteration = 0;
            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –ø–æ–ª—É—á–µ–Ω–Ω–æ–µ –ø—Ä–æ—Å—Ç–æ–µ —á–∏—Å–ª–æ –≤ BigInt
            const p = BigInt(primeNumber);

            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –±–∞–∑–æ–≤–æ–µ —á–∏—Å–ª–æ g (–æ–±—ã—á–Ω–æ 2 –∏–ª–∏ 5)
            const g = 2n;

            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á (—Å–ª—É—á–∞–π–Ω–æ–µ —á–∏—Å–ª–æ –æ—Ç 2 –¥–æ p-2)
            const privateKey = generatePrivateKey(p);

            // –í—ã—á–∏—Å–ª—è–µ–º –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á: publicKey = g^privateKey mod p
            const publicKey = modPow(g, privateKey, p);

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á –≤ sessionStorage
            sessionStorage.setItem('dhKeys', JSON.stringify({
                p: p.toString(),
                g: g.toString(),
                privateKey: privateKey.toString(),
                publicKey: publicKey.toString()
            }));

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            connection.invoke("SendPublicKey", chatData.roomId, publicKey.toString(), 1)
                .catch(err => console.error("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—É–±–ª–∏—á–Ω–æ–≥–æ –∫–ª—é—á–∞:", err));

            console.log("–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –î–∏—Ñ—Ñ–∏-–•–µ–ª–ª–º–∞–Ω–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã");

        } catch (err) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç–æ–∫–µ–Ω–∞:", err);
        }
    });

    connection.on("ReceiveIterationKey", (otherPublicKey, iteration, roomId) => {
        try {
            inIteration++;
            if (inIteration !== iteration) {
                console.log(inIteration);
                console.log(iteration);
                alert("–ù–æ–º–µ—Ä –∏—Ç–µ—Ä–∞—Ü–∏–∏ –æ–±–º–µ–Ω–∞ –∫–ª—é—á–∞–º–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –ª–æ–∫–∞–ª—å–Ω–æ –Ω–µ —Å–æ–≤–ø–∞–ª —Å –¥–∞–Ω–Ω—ã–º–∏ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞, –≤–æ–∑–º–æ–∂–µ–Ω –≤–∑–ª–æ–º");
            }
            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≤ –∫–æ–º–Ω–∞—Ç–µ
            const currentUsersCount = parseInt(document.getElementById('users-count').textContent);

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å –∏—Ç–µ—Ä–∞—Ü–∏–∏
            if (iteration >= currentUsersCount + 666) {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω
                const dhKeys = JSON.parse(sessionStorage.getItem('dhKeys'));
                dhKeys.finalToken = otherPublicKey;
                sessionStorage.setItem('dhKeys', JSON.stringify(dhKeys));

                // –£–≤–µ–¥–æ–º–ª—è–µ–º —Å–µ—Ä–≤–µ—Ä –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∏—Ç–µ—Ä–∞—Ü–∏–π
                connection.invoke("IterationsEnded", roomId)
                    .then(() => console.log("–ò—Ç–µ—Ä–∞—Ü–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω—ã, –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∑–∞–ø—Ä–æ—Å IterationsEnded"))
                    .catch(err => console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ IterationsEnded:", err));
            } else {
                // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –∏—Ç–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å
                IterationProcessKey(otherPublicKey, iteration, roomId);
            }
        } catch (err) {
            console.error("–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ ReceiveIterationKey:", err);
        }
    });

    // –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∏—Ç–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–ª—é—á–∞
    function IterationProcessKey(otherPublicKey, iteration, roomId) {
        try {
            // –ü–æ–ª—É—á–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
            const dhKeys = JSON.parse(sessionStorage.getItem('dhKeys'));
            if (!dhKeys) throw new Error("DH –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã");

            const p = BigInt(dhKeys.p);
            const privateKey = BigInt(dhKeys.privateKey);
            const receivedPublicKey = BigInt(otherPublicKey);

            // –í—ã—á–∏—Å–ª—è–µ–º –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω
            const newPublicToken = modPow(receivedPublicKey, privateKey, p);

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            dhKeys.publicKey = newPublicToken.toString();
            sessionStorage.setItem('dhKeys', JSON.stringify(dhKeys));

            iteration++;
            const currentUsersCount = parseInt(document.getElementById('users-count').textContent);
            if (iteration == currentUsersCount)
            {           
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω
                const dhKeys = JSON.parse(sessionStorage.getItem('dhKeys')) || {};
                dhKeys.finalToken = newPublicToken.toString();
                sessionStorage.setItem('dhKeys', JSON.stringify(dhKeys));

                // –£–≤–µ–¥–æ–º–ª—è–µ–º —Å–µ—Ä–≤–µ—Ä –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∏—Ç–µ—Ä–∞—Ü–∏–π
                connection.invoke("IterationsEnded", roomId)
                    .then(() => console.log("–ò—Ç–µ—Ä–∞—Ü–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω—ã, –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∑–∞–ø—Ä–æ—Å IterationsEnded"))
                    .catch(err => console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ IterationsEnded:", err));
            } else {

                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä —Å ID –∫–æ–º–Ω–∞—Ç—ã
                connection.invoke("SendPublicKey", roomId, newPublicToken.toString(), iteration)
                    .then(() => console.log(`–ò—Ç–µ—Ä–∞—Ü–∏—è ${iteration} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –¥–ª—è –∫–æ–º–Ω–∞—Ç—ã ${roomId}`))
                    .catch(err => console.error(`–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–ª—é—á–∞ –∏—Ç–µ—Ä–∞—Ü–∏–∏ ${iteration}:`, err));
            }

            return newPublicToken;
        } catch (err) {
            console.error(`–û—à–∏–±–∫–∞ –≤ IterationProcessKey (–∏—Ç–µ—Ä–∞—Ü–∏—è ${iteration}):`, err);
            throw err;
        }
    }
    
    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Å–µ–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞
    function generateFinalSecret() {
        const dhKeys = JSON.parse(sessionStorage.getItem('dhKeys'));
        if (!dhKeys?.finalToken) throw new Error("–§–∏–Ω–∞–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω");
        return BigInt(dhKeys.finalToken)
        const p = BigInt(dhKeys.p);
        const privateKey = BigInt(dhKeys.privateKey);
        return modPow(BigInt(dhKeys.finalToken), privateKey, p);
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∏—Ç–µ—Ä–∞—Ü–∏–π
    connection.on("KeyExchangeCompleted", () => {
        try {
            if (inIteration !== usersCount.innerText - 1) {
                console.log(inIteration);
                console.log(usersCount.innerText);
                alert("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Ç–µ—Ä–∞—Ü–∏–π –æ–±–º–µ–Ω–∞ –∫–ª—é—á–∞–º–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ –ª–æ–∫–∞–ª—å–Ω–æ –Ω–µ —Å–æ–≤–ø–∞–ª–æ —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤, –≤–æ–∑–º–æ–∂–µ–Ω –≤–∑–ª–æ–º");
            }
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Å–µ–∫—Ä–µ—Ç
            const finalSecret = generateFinalSecret();
            console.log("–û–±—â–∏–π —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á:", finalSecret.toString());

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
            sessionStorage.setItem('diffieHellmanSecret', finalSecret.toString());

            console.log("–û–±—â–∏–π —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á —Å–æ—Ö—Ä–∞–Ω–µ–Ω:", finalSecret.toString());

            // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
            addMessage('System', '–°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω', 'system');

        } catch (err) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∫–ª—é—á–∞:", err);
            addMessage('System', '–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–µ–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞', 'system');
        }
    });
    
    connection.on("ReceiveSharedSecret", (sharedSecret) => {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±—â–∏–π —Å–µ–∫—Ä–µ—Ç –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è
        sessionStorage.setItem('sharedSecret', sharedSecret);
        console.log("–û–±—â–∏–π —Å–µ–∫—Ä–µ—Ç –ø–æ–ª—É—á–µ–Ω:", sharedSecret);
    });

    // –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
    connection.on("ReceiveEncryptedMessage", async (sender, encryptedMessage) => {
        let typeMessage = 'incoming';
        try {
            // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–≤–æ–∏ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            if (sender === chatData.username) typeMessage = 'outgoing';

            const dhKeys = JSON.parse(sessionStorage.getItem('diffieHellmanSecret'));
            if (!dhKeys) {
                throw new Error("–ù–µ—Ç –∫–ª—é—á–∞ –¥–ª—è –¥–µ—à–∏—Ñ—Ä–æ–≤–∫–∏");
            }

            // –î–µ—à–∏—Ñ—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            const decryptedMessage = await decryptMessage(encryptedMessage, dhKeys);

            // –ü–æ–ª—É—á–∞–µ–º –∏–º—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è (–Ω—É–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —ç—Ç–æ—Ç –º–µ—Ç–æ–¥)

            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            addMessage(sender, decryptedMessage, typeMessage);
        } catch (err) {
            console.error("–û—à–∏–±–∫–∞ –¥–µ—à–∏—Ñ—Ä–æ–≤–∫–∏:", err);
            addMessage('System', '–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ', 'system');
        }
    });

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
    // –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
    async function sendMessage() {
        const messageText = messageInput.value.trim();
        if (!messageText) return;

        try {
            // –ü–æ–ª—É—á–∞–µ–º –æ–±—â–∏–π —Å–µ–∫—Ä–µ—Ç
            const dhKeys = JSON.parse(sessionStorage.getItem('diffieHellmanSecret'));
            console.log(dhKeys)
            if (!dhKeys) {
                throw new Error("–ó–∞—â–∏—â–µ–Ω–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ");
            }

            // –®–∏—Ñ—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            const encryptedMessage = await encryptMessage(messageText, dhKeys.toString());

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            await connection.invoke("SendEncryptedMessage", chatData.roomId, encryptedMessage);
            
            messageInput.value = '';
        } catch (err) {
            console.error("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:", err);
            addMessage('System', `–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ${err.message}`, 'system');
        }
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    sendBtn.addEventListener('click', sendMessage);
    leaveBtn.addEventListener('click', leaveRoom);
    copyBtn.addEventListener('click', copyInviteLink);
    messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
    });

    cameraPhotoBtn.addEventListener("click", async () => {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({video: true});
            const video = document.createElement("video");
            video.srcObject = stream;
            video.play();

            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –Ω–µ–±–æ–ª—å—à–æ–π popup –¥–ª—è —Ñ–æ—Ç–æ
            const modal = createVideoModal("–°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ", video, async () => {
                // –°–æ–∑–¥–∞–µ–º canvas —Å –∫–∞–¥—Ä–æ–º
                const canvas = document.createElement("canvas");
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const ctx = canvas.getContext("2d");
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                canvas.toBlob(blob => {
                    sendEncryptedFile(blob, `photo_${Date.now()}.png`);
                }, "image/png");

                stream.getTracks().forEach(t => t.stop());
            });

            document.body.appendChild(modal);
        } catch (err) {
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ.");
            console.error(err);
        }
    });
    cameraVideoBtn.addEventListener("click", async () => {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({video: true, audio: true});
            const video = document.createElement("video");
            video.srcObject = stream;
            video.play();

            const mediaRecorder = new MediaRecorder(stream);
            let chunks = [];

            mediaRecorder.ondataavailable = e => chunks.push(e.data);
            mediaRecorder.onstop = () => {
                const blob = new Blob(chunks, {type: "video/webm"});
                sendEncryptedFile(blob, `video_${Date.now()}.webm`);
                stream.getTracks().forEach(t => t.stop());
                chunks = [];
            };

            // –°–æ–∑–¥–∞–µ–º popup —Å –∫–Ω–æ–ø–∫–∞–º–∏ –∑–∞–ø–∏—Å–∏
            const modal = createVideoModal("–ó–∞–ø–∏—Å–∞—Ç—å –≤–∏–¥–µ–æ", video, () => {
                if (mediaRecorder.state === "inactive") {
                    mediaRecorder.start();
                    modal.querySelector("#record-btn").textContent = "–°—Ç–æ–ø";
                } else {
                    mediaRecorder.stop();
                    modal.querySelector("#record-btn").textContent = "–ó–∞–ø–∏—Å–∞—Ç—å";
                }
            }, true);

            document.body.appendChild(modal);
        } catch (err) {
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É.");
            console.error(err);
        }
    });

    pasteBtn.addEventListener("click", async () => {
        try {
            const items = await navigator.clipboard.read();
            for (const item of items) {
                for (const type of item.types) {
                    if (type.startsWith("image/") || type.startsWith("application/")) {
                        const blob = await item.getType(type);
                        const fileName = `pasted-${Date.now()}.${type.split("/")[1]}`;
                        await sendEncryptedFile(blob, fileName);
                        return;
                    }
                }
            }

            alert("–ë—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ñ–∞–π–ª –∏–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.");
        } catch (err) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—Å—Ç–∞–≤–∫–µ –∏–∑ –±—É—Ñ–µ—Ä–∞:", err);
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –±—É—Ñ–µ—Ä—É –æ–±–º–µ–Ω–∞.");
        }
    });

    // –í—ã–±–æ—Ä —Ñ–∞–π–ª–∞
    fileInput.addEventListener("change", async () => {
        const file = fileInput.files[0];
        if (!file) return;

        await sendEncryptedFile(file)
    });

    const incomingFiles = new Map(); // fileId => { chunks: [], fileName }

    connection.on("ReceiveFileStart", async (user, fileId, fileName) => {
        const dhKeys = JSON.parse(sessionStorage.getItem('diffieHellmanSecret'));
        fileName = await decryptMessage(fileName, dhKeys);
        incomingFiles.set(fileId, {
            chunks: [],
            fileName: fileName,
            user: user,
            size: 0, // —Å—á—ë—Ç—á–∏–∫ –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –±–∞–π—Ç
            blocked: false,
            error: false,
            ui: createDownloadProgressUI(fileName, user) // —Å–æ–∑–¥–∞—ë–º UI –¥–ª—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        });
    });

    connection.on("ReceiveFileChunk", async (fileId, chunk) => {
        if (typeof chunk === "string") {
            chunk = Uint8Array.from(atob(chunk), c => c.charCodeAt(0));
        }
        for (const [fileId2, data] of incomingFiles) {
            if (data && fileId2 == fileId) {
                data.blocked = true;
                const aesKey = await getDecryptionKey();

                try {
                    // const decrypted = await decryptChunk(aesKey, chunk);
                    const svp = new Uint8Array(chunk)
                    const decrypted = await decryptChunk(aesKey, svp);
                    console.log("decrypted", decrypted);
                    data.chunks.push(decrypted);
                    data.size += decrypted.length;
                    console.log(data.size);

                    const size = data.size;
                    data.ui.progress.textContent = size >= 1048576
                        ? `${(size / 1048576).toFixed(2)} MB –∑–∞–≥—Ä—É–∂–µ–Ω–æ`
                        : `${(size / 1024).toFixed(1)} KB –∑–∞–≥—Ä—É–∂–µ–Ω–æ`;
                    data.blocked = false;
                } catch (e) {
                    data.error = true;
                    console.error("–û—à–∏–±–∫–∞ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏ —á–∞–Ω–∫–∞:", e);
                }

                break;
            }
        }
    });

    connection.on("ReceiveFileEnd", async (fileId) => {
        const data = incomingFiles.get(fileId);
        if (!data) return;

        while (data.blocked) {
            data.ui.progress.textContent = "–í—Å–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ, –∏–¥–µ—Ç —Ä–∞—Å–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ";
            if (data.error) {
                data.ui.progress.textContent = "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ —Ä–∞—Å–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è";
            }
            await delay(500);
        }
        
        const blob = new Blob(data.chunks);
        const url = URL.createObjectURL(blob);
        
        // –î–æ–±–∞–≤–ª—è–µ–º –≤ —á–∞—Ç
        if (blob.size <= 10 * 1024 * 1024 && data.fileName.match(/\.(jpg|jpeg|png|gif|bmp|webp)$/i)) {
            // –ï—Å–ª–∏ —Ñ–∞–π–ª ‚Äî –∫–∞—Ä—Ç–∏–Ω–∫–∞ –∏ –º–µ–Ω—å—à–µ 10 –ú–ë, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ—ë —Å—Ä–∞–∑—É
            const img = document.createElement("img");
            img.src = url;
            img.alt = data.fileName;
            img.style.maxWidth = "300px";
            img.style.maxHeight = "300px";
            img.style.borderRadius = "8px";
            img.style.margin = "5px 0";

            addMessage(data.user, "", "file", false);
            const lastMessage = document.querySelector("#messages .message.file:last-child");
            if (lastMessage) {
                lastMessage.appendChild(img);
            } else {
                // –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–π —Å —Ñ–∞–π–ª–æ–º –Ω–µ—Ç, –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–ª—è–µ–º
                const container = document.getElementById("messages");
                const messageElement = document.createElement("div");
                messageElement.className = "message file";
                messageElement.appendChild(img);
                container.appendChild(messageElement);
            }
        }

        addMessage(data.user, `<a href="${url}" download="${data.fileName}">üìé ${data.fileName}</a>`, "file", false);

        //data.ui.element.remove();

        incomingFiles.delete(fileId);
    });

    // –ó–∞–ø—É—Å–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
    startConnection();
</script>
<script src="js/qrious.min.js"></script>
<script src="js/chatqr.js"></script>
</body>
</html>