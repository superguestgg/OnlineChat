<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ß–∞—Ç –∫–æ–º–Ω–∞—Ç—ã</title>
    <link rel="stylesheet" href="css/chat.css">
    <link rel="stylesheet" href="css/chatqr.css">
    <style>
    </style>
</head>
<body>
<div id="chat-header">
    <h2 id="room-title">–ö–æ–º–Ω–∞—Ç–∞</h2>
    <div id="header-controls">
        <button id="leave-btn">–ü–æ–∫–∏–Ω—É—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
    </div>
</div>

<div id="chat-container">
    <div id="sidebar">
        <h3>–£—á–∞—Å—Ç–Ω–∏–∫–∏ (<span id="users-count">0</span>)</h3>
        <ul class="user-list" id="users-list"></ul>

        <div id="invite-section">
            <h4>–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–∑–µ–π</h4>
            <div id="invite-controls">
                <input type="text" id="invite-link" readonly>
            </div>
            <div id="invite-controls2">
                <button id="copy-btn">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                <button id="qr-btn">–ü–æ–∫–∞–∑–∞—Ç—å QR</button>
            </div>

            <!-- –î–æ–±–∞–≤–ª—è–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è QR-–∫–æ–¥–∞ -->
            <div id="qr-modal"
                 style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center;">
                <div style="background: white; padding: 20px; border-radius: 10px; text-align: center;">
                    <h3>QR-–∫–æ–¥ –¥–ª—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è</h3>
                    <canvas id="qr-canvas"></canvas>
                    <button id="qr-close" style="margin-top: 15px; padding: 5px 15px;">–ó–∞–∫—Ä—ã—Ç—å</button>
                </div>
            </div>
            <div id="copy-success">–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!</div>
        </div>
    </div>

    <div id="messages"></div>
</div>
<div id="active-uploads"></div>
<div id="input-area">
    <input type="text" id="message-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." disabled>
    <button id="send-btn" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>

    <div id="file-controls">
        <label for="file-input" id="file-btn" title="–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª">üìé</label>
        <button id="paste-btn" title="–í—Å—Ç–∞–≤–∏—Ç—å –∏–∑ –±—É—Ñ–µ—Ä–∞">üìã</button>
        <input type="file" id="file-input" style="display: none;">
        <button id="camera-photo-btn" title="–°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ">üì∑</button>
        <button id="camera-video-btn" title="–ó–∞–ø–∏—Å–∞—Ç—å –≤–∏–¥–µ–æ">üé•</button>
        <button id="voice-record-btn" title="–ó–∞–ø–∏—Å–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ">üé§</button>
    </div>

    <div id="file-info" style="display: none;">
        <div id="file-info-top">
            <span id="file-name"></span>
            <span id="file-percent">0%</span>
        </div>
        <progress id="file-progress" value="0" max="100"></progress>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@microsoft/signalr@8.0.7/dist/browser/signalr.min.js">
    // js/signalr.min.js
</script>
<script src="js/chat.js"></script>
<script src="js/chatfiles.js"></script>
<script>
    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ sessionStorage
    let chatData = JSON.parse(sessionStorage.getItem('chatData'));
    if (!chatData || !chatData.roomId || !chatData.username) {
        if (!chatData)
            chatData = Object()
        const urlParams = getUrlParams();
        if (!urlParams.roomId || !urlParams.name) {
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —á–∞—Ç–∞" + chatData.roomId + chatData.username + urlParams.roomId + urlParams.name);
            window.close();
        } else {
            const randomNum = getRandomNumber(1, 1000000);
            chatData.roomId = urlParams.roomId;
            chatData.username = urlParams.name + randomNum;
            chatData.roomName = urlParams.name;
        }
    }

    const connection = new signalR.HubConnectionBuilder()
        .withUrl("/chatHub")
        .configureLogging(signalR.LogLevel.Information)
        .withAutomaticReconnect()
        .build();

    // –≠–ª–µ–º–µ–Ω—Ç—ã UI
    const roomTitle = document.getElementById('room-title');
    const messagesContainer = document.getElementById('messages');
    const messageInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');
    const leaveBtn = document.getElementById('leave-btn');
    const usersList = document.getElementById('users-list');
    const usersCount = document.getElementById('users-count');
    const inviteLinkInput = document.getElementById('invite-link');
    const copyBtn = document.getElementById('copy-btn');
    const copySuccess = document.getElementById('copy-success');

    async function startConnection() {
        try {
            await connection.start();
            console.log("Connected to ChatHub");

            // –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ–º—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ
            const roomInfo = await connection.invoke("JoinRoom", chatData.roomId, chatData.username, chatData.roomName);
            chatData.roomName = roomInfo.roomName;
            roomTitle.textContent = roomInfo.roomName;

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è
            inviteLinkInput.value = generateInviteLink(roomInfo.roomName);

            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º UI
            messageInput.disabled = false;
            sendBtn.disabled = false;
            messageInput.focus();

            // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            addMessage('System', `–í—ã –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ –∫–æ–º–Ω–∞—Ç–µ "${roomInfo.roomName}"`, 'system');

        } catch (err) {
            console.error(err);
            alert(`–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —á–∞—Ç—É ${err}`);
            window.close();
        }
    }

    const fileInput = document.getElementById("file-input");
    const fileBtn = document.getElementById("file-btn");
    const cameraPhotoBtn = document.getElementById("camera-photo-btn");
    const cameraVideoBtn = document.getElementById("camera-video-btn");
    const pasteBtn = document.getElementById("paste-btn");
    const fileInfo = document.getElementById("file-info");
    const fileNameLabel = document.getElementById("file-name");
    const fileProgress = document.getElementById("file-progress");
    const filePercent = document.getElementById("file-percent");
    const voiceBtn = document.getElementById("voice-record-btn");
    let mediaRecorder;
    let audioChunks = [];
    let isRecording = false;

    voiceBtn.addEventListener("click", async () => {
        if (isRecording) {
            // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å
            mediaRecorder.stop();
            voiceBtn.textContent = "üé§";
            isRecording = false;
        } else {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    sendFile(audioBlob, `voice_${Date.now()}.webm`);
                    stream.getTracks().forEach(t => t.stop());
                };

                mediaRecorder.start();
                voiceBtn.textContent = "‚èπ"; // –ö–Ω–æ–ø–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
                isRecording = true;
            } catch (err) {
                alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É.");
                console.error(err);
            }
        }
    });

    cameraPhotoBtn.addEventListener("click", async () => {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({video: true});
            const video = document.createElement("video");
            video.srcObject = stream;
            video.play();

            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –Ω–µ–±–æ–ª—å—à–æ–π popup –¥–ª—è —Ñ–æ—Ç–æ
            const modal = createVideoModal("–°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ", video, async () => {
                // –°–æ–∑–¥–∞–µ–º canvas —Å –∫–∞–¥—Ä–æ–º
                const canvas = document.createElement("canvas");
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const ctx = canvas.getContext("2d");
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                canvas.toBlob(blob => {
                    sendFile(blob, `photo_${Date.now()}.png`);
                }, "image/png");

                stream.getTracks().forEach(t => t.stop());
            });

            document.body.appendChild(modal);
        } catch (err) {
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ.");
            console.error(err);
        }
    });
    cameraVideoBtn.addEventListener("click", async () => {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({video: true, audio: true});
            const video = document.createElement("video");
            video.srcObject = stream;
            video.play();

            const mediaRecorder = new MediaRecorder(stream);
            let chunks = [];

            mediaRecorder.ondataavailable = e => chunks.push(e.data);
            mediaRecorder.onstop = () => {
                const blob = new Blob(chunks, {type: "video/webm"});
                sendFile(blob, `video_${Date.now()}.webm`);
                stream.getTracks().forEach(t => t.stop());
                chunks = [];
            };

            // –°–æ–∑–¥–∞–µ–º popup —Å –∫–Ω–æ–ø–∫–∞–º–∏ –∑–∞–ø–∏—Å–∏
            const modal = createVideoModal("–ó–∞–ø–∏—Å–∞—Ç—å –≤–∏–¥–µ–æ", video, () => {
                if (mediaRecorder.state === "inactive") {
                    mediaRecorder.start();
                    modal.querySelector("#record-btn").textContent = "–°—Ç–æ–ø";
                } else {
                    mediaRecorder.stop();
                    modal.querySelector("#record-btn").textContent = "–ó–∞–ø–∏—Å–∞—Ç—å";
                }
            }, true);

            document.body.appendChild(modal);
        } catch (err) {
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É.");
            console.error(err);
        }
    });

    pasteBtn.addEventListener("click", async () => {
        try {
            const items = await navigator.clipboard.read();
            for (const item of items) {
                for (const type of item.types) {
                    if (type.startsWith("image/") || type.startsWith("application/")) {
                        const blob = await item.getType(type);
                        const fileName = `pasted-${Date.now()}.${type.split("/")[1]}`;
                        await sendFile(blob, fileName);
                        return;
                    }
                }
            }

            alert("–ë—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ñ–∞–π–ª –∏–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.");
        } catch (err) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—Å—Ç–∞–≤–∫–µ –∏–∑ –±—É—Ñ–µ—Ä–∞:", err);
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –±—É—Ñ–µ—Ä—É –æ–±–º–µ–Ω–∞.");
        }
    });

    // –í—ã–±–æ—Ä —Ñ–∞–π–ª–∞
    fileInput.addEventListener("change", async () => {
        const file = fileInput.files[0];
        if (!file) return;

        await sendFile(file)
    });

    const incomingFiles = new Map(); // fileId => { chunks: [], fileName }

    connection.on("ReceiveFileStart", (user, fileId, fileName) => {
        incomingFiles.set(fileId, {
            chunks: [],
            fileName: fileName,
            user: user,
            size: 0, // —Å—á—ë—Ç—á–∏–∫ –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –±–∞–π—Ç
            ui: createDownloadProgressUI(fileName, user) // —Å–æ–∑–¥–∞—ë–º UI –¥–ª—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        });
    });


    connection.on("ReceiveFileChunk", (fileId, chunk) => {
        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º base64 —Å—Ç—Ä–æ–∫—É –æ–±—Ä–∞—Ç–Ω–æ –≤ Uint8Array
        if (typeof chunk === "string") {
            chunk = Uint8Array.from(atob(chunk), c => c.charCodeAt(0));
        }

        for (const [fileId2, data] of incomingFiles) {
            if (data && fileId2 == fileId) {
                console.log(chunk)
                data.chunks.push(chunk);
                data.size += chunk.length;
                console.log(data.size);
                const size = data.size;
                data.ui.progress.textContent = size >= 1048576
                    ? `${(size / 1048576).toFixed(2)} MB –∑–∞–≥—Ä—É–∂–µ–Ω–æ`
                    : `${(size / 1024).toFixed(1)} KB –∑–∞–≥—Ä—É–∂–µ–Ω–æ`;

                break;
            }
        }
    });

    connection.on("ReceiveFileEnd", (fileId) => {
        const data = incomingFiles.get(fileId);
        if (!data) return;

        const blob = new Blob(data.chunks);
        const url = URL.createObjectURL(blob);

        // –î–æ–±–∞–≤–ª—è–µ–º –≤ —á–∞—Ç
        if (blob.size <= 10 * 1024 * 1024 && data.fileName.match(/\.(jpg|jpeg|png|gif|bmp|webp)$/i)) {
            // –ï—Å–ª–∏ —Ñ–∞–π–ª ‚Äî –∫–∞—Ä—Ç–∏–Ω–∫–∞ –∏ –º–µ–Ω—å—à–µ 10 –ú–ë, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ—ë —Å—Ä–∞–∑—É
            const img = document.createElement("img");
            img.src = url;
            img.alt = data.fileName;
            img.style.maxWidth = "300px";
            img.style.maxHeight = "300px";
            img.style.borderRadius = "8px";
            img.style.margin = "5px 0";

            addMessage(data.user, "", "file", false);
            const lastMessage = document.querySelector("#messages .message.file:last-child");
            if (lastMessage) {
                lastMessage.appendChild(img);
            } else {
                // –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–π —Å —Ñ–∞–π–ª–æ–º –Ω–µ—Ç, –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–ª—è–µ–º
                const container = document.getElementById("messages");
                const messageElement = document.createElement("div");
                messageElement.className = "message file";
                messageElement.appendChild(img);
                container.appendChild(messageElement);
            }
        } else if (data.fileName.endsWith(".webm")) {
            const audio = document.createElement("audio");
            audio.controls = true;
            audio.src = url;
            lastMessage.appendChild(audio); // –∏–ª–∏ –∫—É–¥–∞ —Ç–µ–±–µ –Ω—É–∂–Ω–æ
        }


        addMessage(data.user, `<a href="${url}" download="${data.fileName}">üìé ${data.fileName}</a>`, "file", false);

        //data.ui.element.remove();

        incomingFiles.delete(fileId);
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
    connection.on("ReceiveMessage", (user, message) => {
        addMessage(user, message, user === chatData.username ? 'outgoing' : 'incoming');
    });

    connection.on("UserJoined", (username) => {
        addMessage('System', `${username} –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è`, 'system');
    });

    connection.on("UserLeft", (username) => {
        addMessage('System', `${username} –ø–æ–∫–∏–Ω—É–ª —á–∞—Ç`, 'system');
    });

    connection.on("UpdateUsers", (users) => {
        updateUsersList(users);
    });

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
    async function sendMessage() {
        const message = messageInput.value.trim();
        if (!message) return;

        try {
            await connection.invoke("SendMessage", chatData.roomId, message);
            messageInput.value = '';
        } catch (err) {
            console.error("Error sending message:", err);
            addMessage('System', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ', 'system');
        }
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    sendBtn.addEventListener('click', sendMessage);
    leaveBtn.addEventListener('click', leaveRoom);
    copyBtn.addEventListener('click', copyInviteLink);
    messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
    });

    // –ó–∞–ø—É—Å–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
    startConnection();
</script>
<script src="js/qrious.min.js">
    // <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js">
</script>
<script src="js/chatqr.js"></script>
</body>
</html>