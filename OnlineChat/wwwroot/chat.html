<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Чат комнаты</title>
    <link rel="stylesheet" href="css/chat.css">
    <link rel="stylesheet" href="css/chatqr.css">
</head>
<body>
<div id="chat-header">
    <h2 id="room-title">Комната</h2>
    <div id="header-controls">
        <button id="leave-btn">Покинуть комнату</button>
    </div>
</div>

<div id="chat-container">
    <div id="sidebar">
        <h3>Участники (<span id="users-count">0</span>)</h3>
        <ul class="user-list" id="users-list"></ul>

        <div id="invite-section">
            <h4>Пригласить друзей</h4>
            <div id="invite-controls">
                <input type="text" id="invite-link" readonly>
            </div>
            <div id="invite-controls2">
                <button id="copy-btn">Копировать</button>
                <button id="qr-btn">Показать QR</button>
            </div>

            <!-- Добавляем модальное окно для QR-кода -->
            <div id="qr-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center;">
                <div style="background: white; padding: 20px; border-radius: 10px; text-align: center;">
                    <h3>QR-код для приглашения</h3>
                    <canvas id="qr-canvas"></canvas>
                    <button id="qr-close" style="margin-top: 15px; padding: 5px 15px;">Закрыть</button>
                </div>
            </div>
            <div id="copy-success">Ссылка скопирована в буфер обмена!</div>
        </div>
    </div>

    <div id="messages"></div>
</div>

<div id="input-area">
    <input type="text" id="message-input" placeholder="Введите сообщение..." disabled>
    <button id="send-btn" disabled>Отправить</button>
</div>

<script src="js/signalr.min.js">
    // https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js
</script>
<script>
    function getRandomNumber(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }
    
    function getUrlParams() {
        const urlParams = new URLSearchParams(window.location.search);
        return {
            roomId: urlParams.get('room'),
            name: urlParams.get('name') ? decodeURIComponent(urlParams.get('name')) : null
        };
    }
    
    // Получаем данные из sessionStorage
    let chatData = JSON.parse(sessionStorage.getItem('chatData'));
    if (!chatData || !chatData.roomId || !chatData.username) {
        if (!chatData)
            chatData = Object()
        const urlParams = getUrlParams();
        if (!urlParams.roomId || !urlParams.name) {
            alert("Не удалось загрузить данные чата" + chatData.roomId + chatData.username + urlParams.roomId + urlParams.name);
            window.close();
        } else {
            const randomNum = getRandomNumber(1, 1000000);
            chatData.roomId = urlParams.roomId;
            chatData.username = urlParams.name + randomNum;
            chatData.roomName = urlParams.name;
        }
    }

    const connection = new signalR.HubConnectionBuilder()
        .withUrl("/chatHub")
        .configureLogging(signalR.LogLevel.Information)
        .withAutomaticReconnect()
        .build();

    // Элементы UI
    const roomTitle = document.getElementById('room-title');
    const messagesContainer = document.getElementById('messages');
    const messageInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');
    const leaveBtn = document.getElementById('leave-btn');
    const usersList = document.getElementById('users-list');
    const usersCount = document.getElementById('users-count');
    const inviteLinkInput = document.getElementById('invite-link');
    const copyBtn = document.getElementById('copy-btn');
    const copySuccess = document.getElementById('copy-success');

    // Генерация ссылки для приглашения
    function generateInviteLink(roomName) {
        const currentUrl = new URL(window.location.href);
        currentUrl.searchParams.set('room', chatData.roomId);
        currentUrl.searchParams.set('name', encodeURIComponent(roomName));
        return currentUrl.toString();
    }

    // Копирование ссылки
    function copyInviteLink() {
        inviteLinkInput.select();
        document.execCommand('copy');

        // Показываем подтверждение
        copySuccess.style.display = 'block';
        setTimeout(() => {
            copySuccess.style.display = 'none';
        }, 2000);
    }

    async function startConnection() {
        try {
            await connection.start();
            console.log("Connected to ChatHub");

            // Присоединяемся к комнате
            const roomInfo = await connection.invoke("JoinRoom", chatData.roomId, chatData.username, chatData.roomName);
            chatData.roomName = roomInfo.roomName;
            roomTitle.textContent = roomInfo.roomName;

            // Устанавливаем ссылку для приглашения
            inviteLinkInput.value = generateInviteLink(roomInfo.roomName);

            // Активируем UI
            messageInput.disabled = false;
            sendBtn.disabled = false;
            messageInput.focus();

            // Добавляем приветственное сообщение
            addMessage('System', `Вы присоединились к комнате "${roomInfo.roomName}"`, 'system');

        } catch (err) {
            console.error(err);
            alert(`Ошибка подключения к чату ${err}`);
            window.close();
        }
    }

    // Обработчики сообщений от сервера
    connection.on("ReceiveMessage", (user, message) => {
        addMessage(user, message, user === chatData.username ? 'outgoing' : 'incoming');
    });

    connection.on("UserJoined", (username) => {
        addMessage('System', `${username} присоединился`, 'system');
    });

    connection.on("UserLeft", (username) => {
        addMessage('System', `${username} покинул чат`, 'system');
    });

    connection.on("UpdateUsers", (users) => {
        updateUsersList(users);
    });

    // Добавление сообщения в чат
    function addMessage(user, text, type) {
        const messageElement = document.createElement('div');
        messageElement.className = `message ${type}`;
        messageElement.innerHTML = `<strong>${user}:</strong> ${text}`;
        messagesContainer.appendChild(messageElement);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Обновление списка пользователей
    function updateUsersList(users) {
        usersList.innerHTML = '';
        users.forEach(user => {
            const userItem = document.createElement('li');
            userItem.className = 'user-item';
            userItem.innerHTML = `
                    <span class="user-status"></span>
                    ${user} ${user === chatData.username ? '(Вы)' : ''}
                `;
            usersList.appendChild(userItem);
        });
        usersCount.textContent = users.length;
    }

    // Отправка сообщения
    async function sendMessage() {
        const message = messageInput.value.trim();
        if (!message) return;

        try {
            await connection.invoke("SendMessage", chatData.roomId, message);
            messageInput.value = '';
        } catch (err) {
            console.error("Error sending message:", err);
            addMessage('System', 'Не удалось отправить сообщение', 'system');
        }
    }

    // Покидание комнаты
    async function leaveRoom() {
        try {
            await connection.invoke("LeaveRoom", chatData.roomId);
            window.close();
        } catch (err) {
            console.error("Error leaving room:", err);
        }
    }

    // Обработчики событий
    sendBtn.addEventListener('click', sendMessage);
    leaveBtn.addEventListener('click', leaveRoom);
    copyBtn.addEventListener('click', copyInviteLink);
    messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
    });

    // Запуск подключения
    startConnection();
</script>
<script src="js/qrious.min.js">
    // <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
</script>
<script src="js/chatqr.js"></script>
</body>
</html>